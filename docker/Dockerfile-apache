# Use the official PHP image with Apache as the base
FROM php:apache

# Install system dependencies for PHP extensions and MongoDB PHP driver
RUN apt-get update && apt-get install -y \
    libssl-dev \
    git \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install the MongoDB PHP extension
RUN pecl install mongodb \
    && docker-php-ext-enable mongodb

# Enable Apache mod_rewrite for URL rewriting
RUN a2enmod rewrite

# Enable other Apache mods as needed
RUN a2enmod deflate
RUN a2enmod headers
RUN a2enmod brotli

# Apache configuration for mod_deflate, similar to the original setup
# No changes needed here unless you're adjusting compression settings
RUN { \
    echo '<IfModule mod_deflate.c>'; \
    echo '  # Compress HTML, CSS, JavaScript, Text, XML and fonts'; \
    echo '  AddOutputFilterByType DEFLATE application/javascript'; \
    echo '  AddOutputFilterByType DEFLATE application/rss+xml'; \
    echo '  AddOutputFilterByType DEFLATE application/vnd.ms-fontobject'; \
    echo '  AddOutputFilterByType DEFLATE application/x-font'; \
    echo '  AddOutputFilterByType DEFLATE application/x-font-opentype'; \
    echo '  AddOutputFilterByType DEFLATE application/x-font-otf'; \
    echo '  AddOutputFilterByType DEFLATE application/x-font-truetype'; \
    echo '  AddOutputFilterByType DEFLATE application/x-font-ttf'; \
    echo '  AddOutputFilterByType DEFLATE application/x-javascript'; \
    echo '  AddOutputFilterByType DEFLATE application/xhtml+xml'; \
    echo '  AddOutputFilterByType DEFLATE application/xml'; \
    echo '  AddOutputFilterByType DEFLATE font/opentype'; \
    echo '  AddOutputFilterByType DEFLATE font/otf'; \
    echo '  AddOutputFilterByType DEFLATE font/ttf'; \
    echo '  AddOutputFilterByType DEFLATE image/svg+xml'; \
    echo '  AddOutputFilterByType DEFLATE image/x-icon'; \
    echo '  AddOutputFilterByType DEFLATE text/css'; \
    echo '  AddOutputFilterByType DEFLATE text/html'; \
    echo '  AddOutputFilterByType DEFLATE text/javascript'; \
    echo '  AddOutputFilterByType DEFLATE text/plain'; \
    echo '  AddOutputFilterByType DEFLATE text/xml'; \
    echo '</IfModule>'; \
} > /etc/apache2/mods-available/deflate.conf

# Set ServerName to suppress startup warnings
RUN echo 'ServerName localhost' >> /etc/apache2/apache2.conf
